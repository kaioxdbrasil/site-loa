<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="imagens/favconrbo.png">
    <title>Resultados da Consulta Popular - Orçamento 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        body { font-family: 'Inter', sans-serif; color: #1a202c; }
        header { background-color: #2563eb; color: #e3e3e3; padding: 1rem 0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .header-wrapper { max-width: 1280px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 1rem; }
        .logo a img { max-width: 220px; }
        #burguer { display: none; cursor: pointer; }
        nav#itens ul { display: flex; list-style: none; gap: 1.5rem; align-items: center; }
        nav#itens a { color: white; text-decoration: none; font-weight: 500; transition: color 0.3s ease-in-out; }
        nav#itens a:hover { color: #d1d5db; }
        @media (max-width: 768px) {
            #burguer { display: block; }
            nav#itens { display: none; position: absolute; top: 100%; left: 0; width: 100%; background-color: #2563eb; padding: 1rem 0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
            nav#itens.show { display: block; }
            nav#itens ul { flex-direction: column; gap: 1rem; }
        }
    </style>
</head>
<body class="bg-gray-50">
<header>
    <div class="header-wrapper">
        <div class="logo">
            <a href="index.html"><img src="imagens/logo-prefeitura.png" alt="Prefeitura de Rio Branco"></a>
        </div>
        <span id="burguer" class="material-symbols-outlined" onclick="toggleMenu()">menu</span>
        <nav id="itens">
            <ul>
                <li><a href="index.html">Início</a></li>
                <li><a href="voto.html">Participe</a></li>
                <li><a href="resultados.html" class="font-semibold">Resultados</a></li>
            </ul>
        </nav>
    </div>
</header>

<main class="py-16 px-4">
    <div class="container mx-auto max-w-6xl">
        <div class="text-center mb-12">
            <h1 class="text-3xl font-bold text-blue-600">Resultados da Consulta Popular</h1>
            <p class="text-gray-600 mt-3">Acompanhe os registros recebidos no portal de participação do PLOA 2026.</p>
        </div>
        <div id="results-status" class="text-center text-gray-500">Carregando dados...</div>
        <section id="summary-section" class="mt-12 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Resumo Geral</h2>
            <div id="summary-container" class="grid gap-4 md:grid-cols-2 xl:grid-cols-3"></div>
        </section>
        <section id="details-section" class="mt-12 hidden">
            <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between mb-4">
                <h2 class="text-2xl font-semibold text-gray-800">Detalhes dos Registros</h2>
                <p class="text-sm text-gray-500">Explore, filtre e aprofunde-se nas contribuições enviadas.</p>
            </div>
            <div class="bg-white border border-gray-100 rounded-xl shadow-sm p-6 mb-8">
                <div class="flex flex-col gap-6 lg:flex-row lg:items-end lg:justify-between">
                    <div class="w-full lg:max-w-md">
                        <label for="search-input" class="text-sm font-medium text-gray-600">Pesquisar participantes ou sugestões</label>
                        <div class="mt-2 relative">
                            <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">search</span>
                            <input id="search-input" type="search" placeholder="Busque por nome, eixo, bairro ou seleção..." class="w-full rounded-lg border border-gray-200 pl-10 pr-4 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition">
                        </div>
                    </div>
                    <div class="w-full grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="axis-filter" class="text-sm font-medium text-gray-600">Eixo temático</label>
                            <select id="axis-filter" class="mt-2 w-full rounded-lg border border-gray-200 px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition">
                                <option value="all">Todos os eixos</option>
                            </select>
                        </div>
                        <div>
                            <label for="identification-filter" class="text-sm font-medium text-gray-600">Identificação</label>
                            <select id="identification-filter" class="mt-2 w-full rounded-lg border border-gray-200 px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition">
                                <option value="all">Todos os registros</option>
                                <option value="identified">Somente identificados</option>
                                <option value="anonymous">Somente anônimos</option>
                            </select>
                        </div>
                        <div>
                            <label for="bairro-filter" class="text-sm font-medium text-gray-600">Bairro</label>
                            <select id="bairro-filter" class="mt-2 w-full rounded-lg border border-gray-200 px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition">
                                <option value="all">Todos os bairros</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="mt-6 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                    <p id="results-counter" class="text-sm text-gray-500">Carregando registros...</p>
                    <button id="reset-filters" class="inline-flex items-center gap-2 text-sm font-medium text-blue-600 hover:text-blue-700">
                        <span class="material-symbols-outlined text-base">refresh</span>
                        Limpar filtros
                    </button>
                </div>
            </div>
            <div id="results-container" class="grid gap-6 lg:grid-cols-2"></div>
            <div id="pagination" class="mt-8 flex items-center justify-center gap-3 hidden">
                <button id="prev-page" class="px-4 py-2 rounded-lg border border-gray-200 bg-white text-sm font-medium text-gray-600 hover:border-blue-400 hover:text-blue-600 disabled:opacity-50 disabled:cursor-not-allowed">Anterior</button>
                <span id="pagination-info" class="text-sm text-gray-500"></span>
                <button id="next-page" class="px-4 py-2 rounded-lg border border-gray-200 bg-white text-sm font-medium text-gray-600 hover:border-blue-400 hover:text-blue-600 disabled:opacity-50 disabled:cursor-not-allowed">Próxima</button>
            </div>
        </section>
    </div>
</main>

<footer class="bg-white rounded-lg shadow-sm m-4">
    <div class="w-full max-w-screen-xl mx-auto p-4 md:py-8">
        <div class="sm:flex sm:items-center sm:justify-between">
            <a href="index.html" class="flex items-center mb-4 sm:mb-0">
                <img src="imagens/logo-prefeitura.png" class="h-10 me-3" alt="Logo Prefeitura" />
            </a>
            <p class="text-sm text-gray-500">© 2025 Secretaria de Planejamento do Município de Rio Branco. Todos os direitos reservados.</p>
        </div>
    </div>
</footer>

<script>
    function toggleMenu() {
        const navItens = document.getElementById('itens');
        navItens.classList.toggle('show');
    }
</script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBskv58TuCpUzGKFgcc_w1gEt_KmsQ7roI",
        authDomain: "formulario-ploa.firebaseapp.com",
        projectId: "formulario-ploa",
        storageBucket: "formulario-ploa.appspot.com",
        messagingSenderId: "757485086197",
        appId: "1:757485086197:web:9188f474b06337def12cbc"
    };

    const statusEl = document.getElementById('results-status');
    const summarySection = document.getElementById('summary-section');
    const summaryContainer = document.getElementById('summary-container');
    const detailsSection = document.getElementById('details-section');
    const detailsContainer = document.getElementById('results-container');
    const searchInput = document.getElementById('search-input');
    const axisFilter = document.getElementById('axis-filter');
    const identificationFilter = document.getElementById('identification-filter');
    const bairroFilter = document.getElementById('bairro-filter');
    const resetFiltersBtn = document.getElementById('reset-filters');
    const resultsCounter = document.getElementById('results-counter');
    const paginationEl = document.getElementById('pagination');
    const prevPageBtn = document.getElementById('prev-page');
    const nextPageBtn = document.getElementById('next-page');
    const paginationInfo = document.getElementById('pagination-info');

    const ITEMS_PER_PAGE = 6;
    let allSuggestions = [];
    let filteredSuggestions = [];
    let availableAxes = [];
    let availableBairros = [];
    let currentPage = 1;

    let app;

    function escapeHtml(value) {
        if (value === null || value === undefined) return '';
        return String(value)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function formatAxisLabel(axis) {
        if (!axis) return 'Sem eixo';
        return axis
            .replace(/[_-]+/g, ' ')
            .toLowerCase()
            .replace(/(^|\s|\()([a-zá-ú])/g, (match, prefix, letter) => `${prefix}${letter.toUpperCase()}`);
    }

    function formatBooleanLabel(value) {
        if (value === true || value === 'sim' || value === 'Sim') return 'Sim';
        if (value === false || value === 'nao' || value === 'não' || value === 'Não') return 'Não';
        return 'Não informado';
    }

    function populateFilterOptions(axes = [], bairros = [], includeNoNeighborhood = false) {
        availableAxes = axes;
        availableBairros = bairros;

        if (axisFilter) {
            const axisOptions = ['<option value="all">Todos os eixos</option>'];
            axes.forEach((axis) => {
                axisOptions.push(`<option value="${escapeHtml(axis)}">${escapeHtml(formatAxisLabel(axis))}</option>`);
            });
            axisFilter.innerHTML = axisOptions.join('');
        }

        if (bairroFilter) {
            const bairroOptions = ['<option value="all">Todos os bairros</option>'];
            bairros.forEach((bairro) => {
                bairroOptions.push(`<option value="${escapeHtml(bairro)}">${escapeHtml(bairro)}</option>`);
            });
            if (includeNoNeighborhood) {
                bairroOptions.push('<option value="sem-bairro">Sem bairro informado</option>');
            }
            bairroFilter.innerHTML = bairroOptions.join('');
        }
    }

    function updateCounter(total, startIndex, endIndex) {
        if (!resultsCounter) return;
        if (!total) {
            resultsCounter.textContent = 'Nenhum registro encontrado com os filtros atuais.';
            return;
        }
        resultsCounter.textContent = `Exibindo ${startIndex}–${endIndex} de ${total} registros`;
    }

    function createCard(entry) {
        const axisBadges = entry.axes.length
            ? entry.axes.map((axis) => `<span class="inline-flex items-center px-3 py-1 rounded-full bg-blue-50 text-blue-700 text-xs font-semibold">${escapeHtml(formatAxisLabel(axis))}</span>`).join(' ')
            : '<span class="inline-flex items-center px-3 py-1 rounded-full bg-gray-100 text-gray-500 text-xs font-semibold">Sem eixo informado</span>';

        const totalLabel = entry.totalSelections === 1 ? 'seleção' : 'seleções';
        const identificationTag = entry.identificado
            ? '<span class="inline-flex items-center gap-1 text-xs font-semibold text-emerald-600 bg-emerald-50 px-3 py-1 rounded-full"><span class="material-symbols-outlined text-sm">verified_user</span>Identificado</span>'
            : '<span class="inline-flex items-center gap-1 text-xs font-semibold text-amber-600 bg-amber-50 px-3 py-1 rounded-full"><span class="material-symbols-outlined text-sm">visibility_off</span>Anônimo</span>';

        const personalSection = entry.personal
            ? `<ul class="text-sm text-gray-600 space-y-1">
                    ${entry.personal.nome ? `<li><strong>Nome:</strong> ${escapeHtml(entry.personal.nome)}</li>` : ''}
                    ${entry.personal.sexo ? `<li><strong>Sexo:</strong> ${escapeHtml(entry.personal.sexo)}</li>` : ''}
                    ${entry.personal.escolaridade ? `<li><strong>Escolaridade:</strong> ${escapeHtml(entry.personal.escolaridade)}</li>` : ''}
                    ${entry.personal.faixaEtaria ? `<li><strong>Faixa etária:</strong> ${escapeHtml(entry.personal.faixaEtaria)}</li>` : ''}
                </ul>`
            : '<p class="text-sm text-gray-500">Participante não informou dados pessoais.</p>';

        const locationSection = entry.location && (entry.location.moraRioBranco !== undefined || entry.location.bairro)
            ? `<ul class="text-sm text-gray-600 space-y-1">
                    <li><strong>Mora em Rio Branco:</strong> ${formatBooleanLabel(entry.location.moraRioBranco)}</li>
                    ${entry.location.bairro ? `<li><strong>Bairro:</strong> ${escapeHtml(entry.location.bairro)}</li>` : ''}
                </ul>`
            : '<p class="text-sm text-gray-500">Localização não informada.</p>';

        const votesSection = entry.votes.length
            ? entry.votes.map(([axis, selections]) => {
                if (!selections.length) return '';
                return `
                    <div>
                        <h4 class="text-sm font-semibold text-blue-600 mb-1">${escapeHtml(formatAxisLabel(axis))}</h4>
                        <ul class="list-disc list-inside text-sm text-gray-700 space-y-1">
                            ${selections.map((item) => `<li>${escapeHtml(item)}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }).join('')
            : '<p class="text-sm text-gray-500">Nenhuma seleção registrada.</p>';

        return `
            <article class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 flex flex-col gap-4">
                <header class="flex flex-col gap-3">
                    <div class="flex items-center justify-between gap-3">
                        <span class="text-xs font-semibold uppercase tracking-wide text-gray-400">${escapeHtml(entry.id)}</span>
                        <span class="text-sm text-gray-500">${escapeHtml(entry.formattedDate)}</span>
                    </div>
                    <div class="flex flex-wrap items-center gap-3">
                        ${identificationTag}
                        <span class="inline-flex items-center gap-1 text-xs font-medium text-gray-600 bg-gray-100 px-3 py-1 rounded-full">
                            <span class="material-symbols-outlined text-sm">how_to_vote</span>
                            ${entry.totalSelections} ${totalLabel}
                        </span>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        ${axisBadges}
                    </div>
                </header>
                <details class="group">
                    <summary class="flex items-center justify-between cursor-pointer select-none text-sm font-medium text-blue-600 hover:text-blue-700">
                        <span class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-base">insights</span>
                            Ver detalhes completos
                        </span>
                        <span class="material-symbols-outlined text-base transition-transform group-open:rotate-180">expand_more</span>
                    </summary>
                    <div class="mt-4 space-y-5 border-t border-gray-100 pt-4">
                        <section>
                            <h3 class="text-sm font-semibold text-gray-800 mb-2">Dados do participante</h3>
                            ${personalSection}
                        </section>
                        <section>
                            <h3 class="text-sm font-semibold text-gray-800 mb-2">Localização</h3>
                            ${locationSection}
                        </section>
                        <section class="space-y-3">
                            <h3 class="text-sm font-semibold text-gray-800">Sugestões por eixo</h3>
                            ${votesSection}
                        </section>
                    </div>
                </details>
            </article>
        `;
    }

    function renderResults() {
        if (!detailsContainer) return;

        const total = filteredSuggestions.length;
        if (!total) {
            detailsContainer.innerHTML = `
                <div class="col-span-full">
                    <div class="rounded-xl border border-dashed border-gray-300 bg-white/60 backdrop-blur p-8 text-center">
                        <p class="text-lg font-semibold text-gray-700">Nenhum registro encontrado</p>
                        <p class="text-sm text-gray-500 mt-2">Ajuste os filtros ou limpe a pesquisa para visualizar novamente.</p>
                    </div>
                </div>
            `;
            updateCounter(0, 0, 0);
            if (paginationEl) paginationEl.classList.add('hidden');
            return;
        }

        const totalPages = Math.max(1, Math.ceil(total / ITEMS_PER_PAGE));
        if (currentPage > totalPages) {
            currentPage = totalPages;
        }

        const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
        const pageItems = filteredSuggestions.slice(startIndex, startIndex + ITEMS_PER_PAGE);

        detailsContainer.innerHTML = pageItems.map((entry) => createCard(entry)).join('');

        updateCounter(total, startIndex + 1, startIndex + pageItems.length);

        if (paginationEl && prevPageBtn && nextPageBtn && paginationInfo) {
            paginationEl.classList.toggle('hidden', totalPages <= 1);
            paginationInfo.textContent = `Página ${currentPage} de ${totalPages}`;
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;
        }
    }

    function applyFilters() {
        if (!allSuggestions.length) {
            filteredSuggestions = [];
            renderResults();
            return;
        }

        const searchTerm = (searchInput?.value || '').trim().toLowerCase();
        const axisValue = axisFilter?.value || 'all';
        const identificationValue = identificationFilter?.value || 'all';
        const bairroValue = bairroFilter?.value || 'all';

        filteredSuggestions = allSuggestions.filter((entry) => {
            const matchesSearch = !searchTerm || entry.searchText.includes(searchTerm);
            const matchesAxis = axisValue === 'all' || entry.axes.includes(axisValue);
            const matchesIdentification =
                identificationValue === 'all' ||
                (identificationValue === 'identified' && entry.identificado) ||
                (identificationValue === 'anonymous' && !entry.identificado);
            const matchesBairro =
                bairroValue === 'all' ||
                (bairroValue === 'sem-bairro' && !entry.bairro) ||
                entry.bairro === bairroValue;

            return matchesSearch && matchesAxis && matchesIdentification && matchesBairro;
        });

        currentPage = 1;
        renderResults();
    }

    function resetFilters() {
        if (searchInput) searchInput.value = '';
        if (axisFilter) axisFilter.value = 'all';
        if (identificationFilter) identificationFilter.value = 'all';
        if (bairroFilter) bairroFilter.value = 'all';
        currentPage = 1;
        applyFilters();
    }

    if (searchInput) {
        let debounceTimer;
        searchInput.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                currentPage = 1;
                applyFilters();
            }, 250);
        });
    }

    axisFilter?.addEventListener('change', () => {
        currentPage = 1;
        applyFilters();
    });

    identificationFilter?.addEventListener('change', () => {
        currentPage = 1;
        applyFilters();
    });

    bairroFilter?.addEventListener('change', () => {
        currentPage = 1;
        applyFilters();
    });

    resetFiltersBtn?.addEventListener('click', (event) => {
        event.preventDefault();
        resetFilters();
    });

    prevPageBtn?.addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage -= 1;
            renderResults();
        }
    });

    nextPageBtn?.addEventListener('click', () => {
        const totalPages = Math.max(1, Math.ceil(filteredSuggestions.length / ITEMS_PER_PAGE));
        if (currentPage < totalPages) {
            currentPage += 1;
            renderResults();
        }
    });
    try {
        app = initializeApp(firebaseConfig);
    } catch (error) {
        console.error('Erro ao inicializar Firebase:', error);
        statusEl.textContent = 'Não foi possível conectar ao Firebase.';
        statusEl.classList.remove('text-gray-500');
        statusEl.classList.add('text-red-500');
    }

    if (app) {
        const db = getFirestore(app);
        const auth = getAuth(app);
        const initialAuthToken = typeof window !== 'undefined' && window.__initial_auth_token ? window.__initial_auth_token : null;
        const dateFormatter = new Intl.DateTimeFormat('pt-BR', {
            dateStyle: 'short',
            timeStyle: 'short'
        });

        async function loadResults() {
            try {
                const suggestionsRef = collection(db, 'artifacts', 'formulario-ploa', 'public', 'data', 'suggestions');
                const suggestionsQuery = query(suggestionsRef, orderBy('timestamp', 'desc'));
                const snapshot = await getDocs(suggestionsQuery);

                if (snapshot.empty) {
                    statusEl.classList.remove('hidden');
                    statusEl.classList.remove('text-red-500');
                    statusEl.classList.add('text-gray-500');
                    statusEl.textContent = 'Nenhum registro foi encontrado ainda.';
                    summarySection.classList.add('hidden');
                    detailsSection.classList.add('hidden');
                    return;
                }

                const axisTotals = new Map();
                const axesSet = new Set();
                const bairrosSet = new Set();
                let hasMissingBairro = false;
                let totalVotes = 0;
                let identifiedCount = 0;

                const previousFilters = {
                    search: searchInput?.value || '',
                    axis: axisFilter?.value || 'all',
                    identification: identificationFilter?.value || 'all',
                    bairro: bairroFilter?.value || 'all'
                };

                const suggestionsList = snapshot.docs.map((doc) => {
                    const data = doc.data();
                    const timestamp = typeof data.timestamp?.toDate === 'function' ? data.timestamp.toDate() : null;
                    const formattedDate = timestamp ? dateFormatter.format(timestamp) : 'Data não informada';
                    const identificado = data.identificado === 'sim';
                    if (identificado) identifiedCount += 1;

                    const location = data.localizacao || {};
                    const bairroValue = location.bairro ? String(location.bairro) : '';
                    if (bairroValue) {
                        bairrosSet.add(bairroValue);
                    } else {
                        hasMissingBairro = true;
                    }

                    const rawVotes = data.votes || {};
                    const normalizedVotes = Object.entries(rawVotes).map(([axis, selections]) => {
                        const list = Array.isArray(selections) ? selections : (selections ? [selections] : []);
                        axesSet.add(axis);
                        const cleanList = list.filter((item) => item && typeof item === 'string');
                        const current = axisTotals.get(axis) || 0;
                        axisTotals.set(axis, current + cleanList.length);
                        totalVotes += cleanList.length;
                        return [axis, cleanList];
                    });

                    const totalSelections = normalizedVotes.reduce((acc, [, selections]) => acc + selections.length, 0);

                    const personal = data.dadosPessoais ? {
                        nome: data.dadosPessoais.nome || '',
                        sexo: data.dadosPessoais.sexo || '',
                        escolaridade: data.dadosPessoais.escolaridade || '',
                        faixaEtaria: data.dadosPessoais.faixaEtaria || ''
                    } : null;

                    const searchParts = [
                        doc.id,
                        formattedDate,
                        identificado ? 'identificado' : 'anonimo',
                        personal?.nome || '',
                        personal?.sexo || '',
                        personal?.escolaridade || '',
                        personal?.faixaEtaria || '',
                        bairroValue,
                        location?.moraRioBranco ? 'rio branco' : 'fora de rio branco'
                    ];

                    normalizedVotes.forEach(([axis, selections]) => {
                        searchParts.push(axis);
                        selections.forEach((item) => searchParts.push(item));
                    });

                    return {
                        id: doc.id,
                        identificado,
                        timestamp,
                        formattedDate,
                        personal,
                        location,
                        bairro: bairroValue,
                        axes: normalizedVotes.map(([axis]) => axis),
                        votes: normalizedVotes,
                        totalSelections,
                        searchText: searchParts.join(' ').toLowerCase()
                    };
                });

                allSuggestions = suggestionsList;

                const sortedAxes = Array.from(axesSet).sort((a, b) => formatAxisLabel(a).localeCompare(formatAxisLabel(b), 'pt-BR'));
                const sortedBairros = Array.from(bairrosSet).sort((a, b) => a.localeCompare(b, 'pt-BR'));

                populateFilterOptions(sortedAxes, sortedBairros, hasMissingBairro);

                if (searchInput) searchInput.value = previousFilters.search;

                if (axisFilter) {
                    axisFilter.value = previousFilters.axis !== 'all' && axesSet.has(previousFilters.axis)
                        ? previousFilters.axis
                        : 'all';
                }

                if (identificationFilter) {
                    identificationFilter.value = previousFilters.identification;
                }

                if (bairroFilter) {
                    if (previousFilters.bairro === 'sem-bairro' && hasMissingBairro) {
                        bairroFilter.value = 'sem-bairro';
                    } else if (previousFilters.bairro !== 'all' && bairrosSet.has(previousFilters.bairro)) {
                        bairroFilter.value = previousFilters.bairro;
                    } else {
                        bairroFilter.value = 'all';
                    }
                }

                currentPage = 1;
                applyFilters();

                const totalDocuments = snapshot.size;
                const summaryCards = [
                    {
                        title: 'Total de participações',
                        value: totalDocuments,
                        icon: 'groups'
                    },
                    {
                        title: 'Identificados',
                        value: identifiedCount,
                        icon: 'badge'
                    },
                    {
                        title: 'Anônimos',
                        value: totalDocuments - identifiedCount,
                        icon: 'person_off'
                    },
                    {
                        title: 'Total de escolhas registradas',
                        value: totalVotes,
                        icon: 'how_to_vote'
                    }
                ];

                Array.from(axisTotals.entries())
                    .sort((a, b) => formatAxisLabel(a[0]).localeCompare(formatAxisLabel(b[0]), 'pt-BR'))
                    .forEach(([axis, total]) => {
                        summaryCards.push({
                            title: `Seleções em ${formatAxisLabel(axis)}`,
                            value: total,
                            icon: 'bar_chart'
                        });
                    });

                summaryContainer.innerHTML = summaryCards.map(({ title, value, icon }) => `
                    <div class="bg-white rounded-xl shadow-md p-6 flex items-center gap-4 border border-gray-100">
                        <span class="material-symbols-outlined text-blue-600 text-3xl">${icon}</span>
                        <div>
                            <p class="text-sm text-gray-500">${title}</p>
                            <p class="text-2xl font-bold text-gray-800">${value}</p>
                        </div>
                    </div>
                `).join('');

                statusEl.classList.remove('hidden');
                statusEl.classList.remove('text-red-500');
                statusEl.classList.add('text-gray-500');
                statusEl.textContent = totalVotes > 0
                    ? `Resultados atualizados em ${dateFormatter.format(new Date())}`
                    : 'Nenhuma participação registrada até o momento.';

                summarySection.classList.remove('hidden');
                detailsSection.classList.remove('hidden');
            } catch (error) {
                console.error('Erro ao carregar resultados:', error);
                statusEl.classList.remove('hidden');
                statusEl.classList.remove('text-gray-500');
                statusEl.classList.add('text-red-500');
                statusEl.textContent = error.code === 'permission-denied'
                    ? 'Você não tem permissão para acessar estes resultados. Contate um administrador.'
                    : 'Erro ao carregar os resultados. Tente novamente mais tarde.';
            }
        }

        statusEl.textContent = 'Conectando ao servidor...';

        async function authenticate() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error('Erro ao autenticar:', error);
                statusEl.textContent = 'Não foi possível autenticar para carregar os resultados.';
                statusEl.classList.remove('text-gray-500');
                statusEl.classList.add('text-red-500');
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                statusEl.textContent = 'Carregando dados...';
                loadResults();
            }
        });

        authenticate();
    }
</script>

</body>
</html>
